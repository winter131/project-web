name: 🚀 CI/CD Auto Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 🎯 Checkout Code
        uses: actions/checkout@v3

      - name: 🔐 Test Rancher Connection Only
        run: |
          mkdir -p ~/.kube
          cat > ~/.kube/config <<EOF
          apiVersion: v1
          kind: Config
          clusters:
          - name: "rancher-15-56"
            cluster:
              server: "https://rancher-15-56.its.ac.id/k8s/clusters/local"
              insecure-skip-tls-verify: true
          users:
          - name: "rancher-15-56"
            user:
              token: "${{ secrets.RANCHER_TOKEN }}"
          contexts:
          - name: "rancher-15-56"
            context:
              cluster: "rancher-15-56"
              user: "rancher-15-56"
          current-context: "rancher-15-56"
          EOF

          echo "🔌 Testing Rancher connection..."
          kubectl get nodes --insecure-skip-tls-verify
          echo "✅ Connection successful!"

          echo "📊 Checking projectweb deployment..."
          kubectl get deployment projectweb -n default --insecure-skip-tls-verify
          echo "🎉 Test completed successfully!"
